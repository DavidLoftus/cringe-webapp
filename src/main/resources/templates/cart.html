<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" lang="en">
<!--/*@thymesVar id="user" type="cringe.app.db.User"*/-->
<!--/*@thymesVar id="totalCost" type="java.lang.Float"*/-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="stylesheet" type="text/css" href="/css/cart.css">


    <script>
        function removeFromCart(id) {
            fetch('/cart/remove', {
                method: 'POST',
                body: new URLSearchParams({
                    id: id,
                })
            }).then( resp => {
                if (resp.ok) {
                    // Reduce total price
                    var totalPrice = document.getElementById('totalPrice');
                    const gamePrice = parseFloat(document.getElementById('game_price_' + id).innerText);
                    console.log("Total Price: " + totalPrice.innerText);
                    console.log("Game Price: " + gamePrice);
                    console.log("New Price: " + (parseFloat(totalPrice.innerText) - gamePrice));
                    totalPrice.innerText = (parseFloat(totalPrice.innerText) - gamePrice).toFixed(2);

                    // Remove row
                    const row = document.getElementById('game_' + id);
                    row.remove();

                    // If cart is empty, remove checkout button
                    const cart = document.getElementById('cart');
                    console.log("Num of rows: " + cart.rows.length);
                    if(cart.rows.length == 2) {
                        document.getElementById('btn-checkout').remove();
                    }
                }
            })
        }
    </script>

    <title>Cringe Games</title>
</head>
<body>
<div th:replace="fragments/header :: header" class="globalHeader"></div>


<div class="mainContent">
    <div class="content">
        <h1>Your Shopping Cart</h1>
        <div th:id="|game_${game.id}|" th:each="game : ${ cart.games }" class="cart-item">
            <div class="cart-item-image">
                <a th:attr="href=${#paths.view(game)}">
                    <img th:src="${#paths.get(game.logo)}">
                </a>
            </div>
            <div class="cart-item-price">
                <div class="price" th:id="|game_price_${game.id}|" th:text="${#numbers.formatDecimal(game.price, 0, 'COMMA', 2, 'POINT') + '€'}">30.00€</div>
                <a class="links" th:onclick="|removeFromCart(${ game.id })|">Remove</a>
            </div>
            <div class="cart-item-name" th:text="${game.title}">
                GTA V
            </div>
        </div>
        <div th:if="${!cart.games.isEmpty()}" class="cart-payment">
            <div class="total">
                <div id="totalPrice" class="total-price" th:text="${#numbers.formatDecimal(cart.totalCost, 0, 'COMMA', 2, 'POINT') + '€'}">
                    30.00€
                </div>
                Estimated Total
            </div>
            <div class="buttons">
                <a class="big-buy-button" href="/cart/checkout">
                    <span>Checkout</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
</body>
</html>